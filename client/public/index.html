<!DOCTYPE html>
<html>
  <head>
    <title>
      simple collab



    </title>
    <style>
      #foo {
        width: 300px;
        border: 1px solid black;
        height: 100px;
        padding: 10px;
        margin-left: auto;
        margin-right: auto;
      }


    </style>
  </head>
  <body ng-app="simpleCollab" ng-controller="collab_ctrl">
    <div ng-model="db" id="foo" onchange="blah()"></div>


    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="public/getCarrot.js"></script>

    <script>
      var socket = io('http://localhost:3002');
      var app = angular.module("simpleCollab", []);
      const myKey=0;
      var doc = document.getElementById('foo');
      doc.contentEditable = true;
      doc.focus();
      console.log(getCaretPosition(),getCaretCharacterOffsetWithin(document.getElementById("foo")));
      
      
      document.addEventListener("keypress", (e)=>{
        socket.emit("change",JSON.stringify({
          "value": e.key,
          "index": getCaretPosition(), 
          "length": doc.innerHTML.length+1,
          "op": 'i',
          "key": myKey
        }));
      },false);
      
      
      
      function blah(){
        console.log("hi");
      }
      
      
      
      app.controller("collab_ctrl", function($scope) {
        $scope.db="";
        $scope.pv="";
        $scope.shifting=false;

        $scope.onKeyDownResult = "";
        $scope.onKeyUpResult = "";
        $scope.onKeyPressResult = "";


        $scope.bloop = function(){
          console.log("hi");
        }



        var getKeyboardEventResult = function (keyEvent) {
          return (window.event ? keyEvent.keyCode : keyEvent.which);
        };

        // Event handlers
        $scope.onKeyDown = function ($event) {
          $scope.onKeyDownResult = getKeyboardEventResult($event);
          if($scope.onKeyDownResult==16) {
            $scope.shifting = true;
          }
        };

        $scope.onKeyUp = function ($event) {
          $scope.onKeyUpResult = getKeyboardEventResult($event);
          if($scope.onKeyDownResult==16) {
            $scope.shifting = false;
          }
        };

        $scope.onKeyPress = function ($event) {
          $scope.onKeyPressResult = getKeyboardEventResult($event);
    
        };

        $scope.onClick = function() {
        }
      });

      

      
        socket.on('connect', function(){
          socket.emit("key",JSON.stringify({key:myKey}));
        });
        socket.on('event', function(data){
          // console.log(data);
        });
//      key: 1, index: 5, length: 1, op: "i"
        socket.on('change',function(data){
          var pl = JSON.parse(data);
          if(pl.key!=myKey){
            //insert first character
            if(pl.length==1 && pl.index==5){
              doc.innerHTML = pl.value;
              setCaretPosition("foo",length);
            } else {
              doc.innerHTML += pl.value;
            }
          }
        })
      
      
        socket.on('disconnect', function(){});
    </script>
  </body>
</html>
